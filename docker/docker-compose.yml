version: '3.8'

services:
  # Azure MCP Documentation Generator
  # Generates 590+ markdown documentation files from CLI output JSON files
  # Prerequisites: CLI output files must exist in generated/cli/ (run ./run-mcp-cli-output.sh first)
  docgen:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_ID: "${UID:-1000}"
        GROUP_ID: "${GID:-1000}"
    image: azure-mcp-docgen:latest
    container_name: azure-mcp-docgen
    user: "${UID:-1000}:${GID:-1000}"
    
    # Mount local directory for output
    volumes:
      - ../generated:/output
      # Optional: Mount custom config files if you want to override defaults
      # - ../custom-config.json:/docs-generation/config.json:ro
      # - ../custom-brand-mapping.json:/docs-generation/brand-to-server-mapping.json:ro
    
    environment:
      # Allow using preview .NET runtime
      - DOTNET_ROLL_FORWARD=Major
      # Skip CLI generation (CLI files already generated locally)
      - SKIP_CLI_GENERATION=true
    
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    
    # Automatically remove container after completion
    # Comment out if you want to inspect the container after it runs
    # remove: true
    
  # Interactive debugging service
  # Access container shell for debugging and development
  # Usage: docker-compose -f docker/docker-compose.yml --profile debug run --rm docgen-interactive
  docgen-interactive:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        USER_ID: "${UID:-1000}"
        GROUP_ID: "${GID:-1000}"
    image: azure-mcp-docgen:latest
    container_name: azure-mcp-docgen-debug
    user: "${UID:-1000}:${GID:-1000}"
    
    volumes:
      - ../generated:/output
      # Mount the entire docs-generation folder for live editing during debug
      - ../docs-generation:/docs-generation
    
    environment:
      - DOTNET_ROLL_FORWARD=Major
      - SKIP_CLI_GENERATION=true
    
    # Override entrypoint for interactive shell
    entrypoint: ["/bin/bash"]
    command: []
    
    # Keep container running for debugging
    stdin_open: true
    tty: true
    
    # Don't start this service by default
    profiles:
      - debug
