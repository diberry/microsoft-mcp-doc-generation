version: '3.8'

services:
  # Azure MCP Documentation Generator
  docgen:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        # Specify which branch of Microsoft/MCP to use
        MCP_BRANCH: main
        USER_ID: "${UID:-1000}"
        GROUP_ID: "${GID:-1000}"
    image: azure-mcp-docgen:latest
    container_name: azure-mcp-docgen
    user: "${UID:-1000}:${GID:-1000}"
    
    # Mount local directory for output
    volumes:
      - ../generated:/output
      # Optional: Mount custom config files if you want to override defaults
      # - ../custom-config.json:/docs-generation/config.json:ro
      # - ../custom-brand-mapping.json:/docs-generation/brand-to-server-mapping.json:ro
    
    environment:
      # Allow using preview .NET runtime
      - DOTNET_ROLL_FORWARD=Major
      # Optional: Customize MCP server path if needed
      # - MCP_SERVER_PATH=/mcp/servers/Azure.Mcp.Server/src
    
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    
    # Automatically remove container after completion
    # Comment out if you want to inspect the container after it runs
    # remove: true
    
  # Lightweight Azure MCP CLI (no documentation generation)
  # Use this for quick MCP server CLI commands
  mcp-cli:
    build:
      context: ..
      dockerfile: docker/Dockerfile.cli
      args:
        MCP_BRANCH: main
        USER_ID: "${UID:-1000}"
        GROUP_ID: "${GID:-1000}"
    image: azure-mcp-cli:latest
    container_name: azure-mcp-cli
    user: "${UID:-1000}:${GID:-1000}"
    
    # Override to run specific commands
    # Example: docker-compose run --rm mcp-cli tools list
    command: []
    
    # Don't start this service by default
    profiles:
      - cli
  
  # Alternative service for interactive debugging
  docgen-interactive:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        MCP_BRANCH: main
        USER_ID: "${UID:-1000}"
        GROUP_ID: "${GID:-1000}"
    image: azure-mcp-docgen:latest
    container_name: azure-mcp-docgen-debug
    user: "${UID:-1000}:${GID:-1000}"
    
    volumes:
      - ../generated:/output
      # Mount the entire docs-generation folder for live editing during debug
      - ../docs-generation:/docs-generation
    
    environment:
      - DOTNET_ROLL_FORWARD=Major
    
    # Override entrypoint for interactive shell
    entrypoint: ["/bin/bash"]
    command: []
    
    # Keep container running for debugging
    stdin_open: true
    tty: true
    
    # Don't start this service by default
    profiles:
      - debug
