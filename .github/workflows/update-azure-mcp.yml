name: Update @azure/mcp Version

on:
  # Run nightly at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * *'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: update-azure-mcp
  cancel-in-progress: false

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Check current and latest versions
        id: version-check
        working-directory: ./test-npm-azure-mcp
        run: |
          echo "Checking @azure/mcp version..."
          
          # Get current version from package.json
          # Note: This strips simple semver prefixes (^, ~). For complex ranges, installed version is used.
          CURRENT_VERSION=$(node -p "require('./package.json').dependencies['@azure/mcp']" | sed 's/[\^~]//g')
          echo "Current version: $CURRENT_VERSION"
          
          # Get latest version from npm registry
          LATEST_VERSION=$(npm view @azure/mcp version)
          echo "Latest version: $LATEST_VERSION"
          
          # Export for use in other steps
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          # Check if update is needed
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âœ… Update available: $CURRENT_VERSION â†’ $LATEST_VERSION"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date at version $CURRENT_VERSION"
          fi

      - name: Update package to latest version
        if: steps.version-check.outputs.needs_update == 'true'
        working-directory: ./test-npm-azure-mcp
        run: |
          echo "Updating @azure/mcp to version ${{ steps.version-check.outputs.latest_version }}..."
          
          # Update to the latest version
          npm install @azure/mcp@latest
          
          # Verify the update succeeded
          NEW_VERSION=$(node -p "require('./package.json').dependencies['@azure/mcp']" | sed 's/[\^~]//g')
          echo "Updated to version: $NEW_VERSION"
          
          # Validate version matches expected
          if [ "$NEW_VERSION" != "${{ steps.version-check.outputs.latest_version }}" ]; then
            echo "::error::Version mismatch after update. Expected ${{ steps.version-check.outputs.latest_version }}, got $NEW_VERSION"
            exit 1
          fi
          
          echo "âœ… Version verified successfully"

      - name: Test installation
        if: steps.version-check.outputs.needs_update == 'true'
        working-directory: ./test-npm-azure-mcp
        run: |
          echo "Testing @azure/mcp installation..."
          npx azmcp --version
          npx azmcp --help
          echo "âœ… Installation test passed"

      - name: Close previous automated PRs
        if: steps.version-check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing automated PRs..."
          
          # Find all open PRs with the 'automated' label created by this workflow
          EXISTING_PRS=$(gh pr list --label "automated" --label "dependencies" --json number,headRefName,title --jq '.[] | select(.headRefName | startswith("update-azure-mcp-")) | .number')
          
          if [ -n "$EXISTING_PRS" ]; then
            echo "Found existing automated PR(s) to close:"
            for PR_NUMBER in $EXISTING_PRS; do
              echo "  Closing PR #$PR_NUMBER"
              gh pr close $PR_NUMBER --comment "Closing this PR as a newer version update is available." --delete-branch || true
            done
            echo "âœ… Closed previous automated PRs"
          else
            echo "No existing automated PRs found"
          fi

      - name: Create Pull Request
        if: steps.version-check.outputs.needs_update == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update @azure/mcp to ${{ steps.version-check.outputs.latest_version }}'
          title: 'chore(deps): update @azure/mcp to ${{ steps.version-check.outputs.latest_version }}'
          body: |
            ## Automated Dependency Update
            
            This PR updates `@azure/mcp` in the `test-npm-azure-mcp` directory to the latest version.
            
            ### Changes
            - **Package**: `@azure/mcp`
            - **Current Version**: `${{ steps.version-check.outputs.current_version }}`
            - **New Version**: `${{ steps.version-check.outputs.latest_version }}`
            
            ### Files Updated
            - `test-npm-azure-mcp/package.json`
            - `test-npm-azure-mcp/package-lock.json`
            
            ### Verification Steps
            Please verify that:
            - [ ] The package installs correctly
            - [ ] All scripts in package.json still work
            - [ ] The Azure MCP CLI commands function as expected
            
            ### Release Notes
            Check the release notes for breaking changes: https://www.npmjs.com/package/@azure/mcp?activeTab=versions
            
            ---
            
            ðŸ¤– This PR was automatically generated by the `update-azure-mcp` workflow.
          branch: update-azure-mcp-${{ steps.version-check.outputs.latest_version }}
          delete-branch: true
          labels: |
            dependencies
            automated
          assignees: ${{ github.repository_owner }}

      - name: PR Created Info
        if: steps.version-check.outputs.needs_update == 'true' && steps.create-pr.outputs.pull-request-number
        run: |
          echo "âœ… Pull Request created successfully!"
          echo "PR Number: ${{ steps.create-pr.outputs.pull-request-number }}"
          echo "PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"

      - name: Enable Auto-merge
        if: steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Enabling auto-merge for PR #${{ steps.create-pr.outputs.pull-request-number }}..."
          gh pr merge --auto --squash ${{ steps.create-pr.outputs.pull-request-number }} || echo "âš ï¸ Auto-merge not enabled - may require branch protection rules"
          echo "âœ… Auto-merge enabled (will merge when checks pass)"

      - name: Summary
        if: always()
        run: |
          echo "## Update Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: ${{ steps.version-check.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Version**: ${{ steps.version-check.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Needed**: ${{ steps.version-check.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.version-check.outputs.needs_update }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… A pull request has been created to update @azure/mcp" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… No update needed - already using the latest version" >> $GITHUB_STEP_SUMMARY
          fi
