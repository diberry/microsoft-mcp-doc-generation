name: Test Secrets Configuration

on:
  workflow_dispatch:

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Create .env file from secrets
      run: |
        echo "=== Creating .env file from secrets ==="
        mkdir -p docs-generation
        {
          echo "FOUNDRY_API_KEY=${{ secrets.FOUNDRY_API_KEY }}"
          echo "FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }}"
          echo "FOUNDRY_MODEL_NAME=${{ secrets.FOUNDRY_MODEL_NAME }}"
          echo "FOUNDRY_MODEL_API_VERSION=${{ secrets.FOUNDRY_MODEL_API_VERSION }}"
        } > docs-generation/.env
        echo "✅ .env file created"
        echo ""
        
    - name: Check .env file contents
      run: |
        echo "=== .env File Contents ==="
        cat docs-generation/.env
        echo ""
        echo "=== File size ==="
        ls -lh docs-generation/.env
        FILE_SIZE=$(wc -c < docs-generation/.env)
        echo "Size in bytes: $FILE_SIZE"
        echo ""
        
    - name: Check environment variable lengths
      run: |
        echo "=== Environment Variable Lengths ==="
        echo ""
        
        # Check secret lengths directly (before writing to .env)
        echo "GitHub Secret Lengths (direct):"
        SECRET_API_KEY="${{ secrets.FOUNDRY_API_KEY }}"
        SECRET_ENDPOINT="${{ secrets.FOUNDRY_ENDPOINT }}"
        SECRET_MODEL_NAME="${{ secrets.FOUNDRY_MODEL_NAME }}"
        SECRET_API_VERSION="${{ secrets.FOUNDRY_MODEL_API_VERSION }}"
        
        echo "  FOUNDRY_API_KEY: ${#SECRET_API_KEY} chars"
        echo "  FOUNDRY_ENDPOINT: ${#SECRET_ENDPOINT} chars"
        echo "  FOUNDRY_MODEL_NAME: ${#SECRET_MODEL_NAME} chars"
        echo "  FOUNDRY_MODEL_API_VERSION: ${#SECRET_API_VERSION} chars"
        echo ""
        
        # Load the .env file
        set -a
        source docs-generation/.env
        set +a
        
        # Check each variable from .env
        echo "Values from .env file (after source):"
        echo "FOUNDRY_API_KEY:"
        echo "  Length: ${#FOUNDRY_API_KEY}"
        echo "  First 4 chars: ${FOUNDRY_API_KEY:0:4}..."
        echo ""
        
        echo "FOUNDRY_ENDPOINT:"
        echo "  Length: ${#FOUNDRY_ENDPOINT}"
        echo "  First 4 chars: ${FOUNDRY_ENDPOINT:0:4}..."
        echo ""
        
        echo "FOUNDRY_MODEL_NAME:"
        echo "  Length: ${#FOUNDRY_MODEL_NAME}"
        echo "  First 4 chars: ${FOUNDRY_MODEL_NAME:0:4}..."
        echo ""
        
        echo "FOUNDRY_MODEL_API_VERSION:"
        echo "  Length: ${#FOUNDRY_MODEL_API_VERSION}"
        echo "  First 4 chars: ${FOUNDRY_MODEL_API_VERSION:0:4}..."
        echo ""
        
    - name: Verify all variables are set
      run: |
        set -a
        source docs-generation/.env
        set +a
        
        echo "=== Verification Status ==="
        
        if [ -z "$FOUNDRY_API_KEY" ]; then
          echo "❌ FOUNDRY_API_KEY is empty or not set"
          exit 1
        else
          echo "✅ FOUNDRY_API_KEY is set (${#FOUNDRY_API_KEY} chars)"
        fi
        
        if [ -z "$FOUNDRY_ENDPOINT" ]; then
          echo "❌ FOUNDRY_ENDPOINT is empty or not set"
          exit 1
        else
          echo "✅ FOUNDRY_ENDPOINT is set (${#FOUNDRY_ENDPOINT} chars)"
        fi
        
        if [ -z "$FOUNDRY_MODEL_NAME" ]; then
          echo "❌ FOUNDRY_MODEL_NAME is empty or not set"
          exit 1
        else
          echo "✅ FOUNDRY_MODEL_NAME is set (${#FOUNDRY_MODEL_NAME} chars)"
        fi
        
        if [ -z "$FOUNDRY_MODEL_API_VERSION" ]; then
          echo "❌ FOUNDRY_MODEL_API_VERSION is empty or not set"
          exit 1
        else
          echo "✅ FOUNDRY_MODEL_API_VERSION is set (${#FOUNDRY_MODEL_API_VERSION} chars)"
        fi
        
        echo ""
        echo "✅ All required secrets are configured correctly!"
