name: Generate MCP Documentation

on:
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v5
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build documentation generator image
      run: |
        echo "=== Building Azure MCP Documentation Generator ==="
        docker build \
          --tag azure-mcp-docgen:latest \
          --build-arg MCP_BRANCH=main \
          --progress=plain \
          .
        
        echo "âœ… Docker image built successfully"
        docker images azure-mcp-docgen:latest
        
    - name: Run documentation generation
      run: |
        echo "=== Running Documentation Generation ==="
        
        # Create output directory
        mkdir -p generated
        
        # Run the container
        docker run \
          --rm \
          --volume "$(pwd)/generated:/output" \
          --env DOTNET_ROLL_FORWARD=Major \
          --env MCP_SERVER_PATH=/mcp/servers/Azure.Mcp.Server/src \
          azure-mcp-docgen:latest
        
        echo "=== Verifying Generated Output ==="
        if [ -d "generated/multi-page" ]; then
          echo "âœ… Documentation generated successfully"
          file_count=$(find generated/multi-page -name "*.md" -type f | wc -l)
          echo "ðŸ“„ ${file_count} markdown files created"
        else
          echo "âŒ Documentation generation failed"
          ls -la generated/
          exit 1
        fi
        
    - name: Display generation summary
      if: always()
      run: |
        echo "=== Generation Summary ==="
        echo "Job status: ${{ job.status }}"
        echo ""
        
        # Show generated files
        if [ -d "generated/multi-page" ]; then
          echo "âœ… Generated documentation files:"
          find generated/multi-page -name "*.md" -type f | sort | while read -r file; do
            size=$(stat -c%s "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
          done
        else
          echo "âš ï¸  No multi-page documentation directory found"
        fi
        
        # Show data files
        echo ""
        echo "Data files:"
        for file in generated/*.json generated/*.csv; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
          fi
        done
        
        # Show summary if available
        if [ -f "generated/generation-summary.md" ]; then
          echo ""
          echo "=== Summary from generation-summary.md ==="
          head -20 generated/generation-summary.md
        fi
        
        echo "=== End Summary ==="
        
    - name: Upload generated documentation
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generated-docs
        path: |
          generated/
        retention-days: 30
        
    - name: Create documentation archive
      if: success()
      run: |
        cd generated
        zip -r ../azure-mcp-docs.zip .
        cd ..
        echo "ðŸ“¦ Created azure-mcp-docs.zip ($(du -h azure-mcp-docs.zip | cut -f1))"
        
    - name: Upload documentation archive
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: azure-mcp-docs-archive
        path: azure-mcp-docs.zip
        retention-days: 30

    # Optional: Push to GitHub Container Registry
    # Uncomment if you want to publish the image
    # - name: Login to GitHub Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}
    #
    # - name: Push Docker image
    #   run: |
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
