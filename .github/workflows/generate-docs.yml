name: Generate MCP Documentation

on:
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v5
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Generate MCP CLI output files
      run: |
        chmod +x ./run-mcp-cli-output.sh
        ./run-mcp-cli-output.sh
    
    - name: Upload CLI output artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mcp-cli-output-${{ github.run_id }}-$(date +%Y-%m-%d-%H-%M)
        path: |
          generated/cli/
        retention-days: 30
      
    - name: Create .env file for documentation generation
      run: |
        echo "=== Creating .env file ==="
        mkdir -p docs-generation
        cat > docs-generation/.env << 'EOF'
FOUNDRY_API_KEY=${{ secrets.FOUNDRY_API_KEY }}
FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }}
FOUNDRY_MODEL_NAME=${{ secrets.FOUNDRY_MODEL_NAME }}
FOUNDRY_MODEL_API_VERSION=${{ secrets.FOUNDRY_MODEL_API_VERSION }}
EOF
        echo "âœ… .env file created"

    - name: Run content generation (documentation + example prompts)
      run: |
        chmod +x ./run-content-generation-output.sh
        ./run-content-generation-output.sh

    - name: Upload Tool output artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: tool-output-${{ github.run_id }}-$(date +%Y-%m-%d-%H-%M)
        path: |
          generated/
        retention-days: 30

    - name: Run generative ai 
      run: |
        chmod +x ./run-generative-ai-output.sh
        chmod +x ./docs-generation/Generate-ExamplePrompts.sh
        ./run-generative-ai-output.sh

    - name: Upload Generative AI output artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generative-output-${{ github.run_id }}-$(date +%Y-%m-%d-%H-%M)
        path: |
          generated/
        retention-days: 30

    # - name: Display generation summary
    #   if: always()
    #   run: |
    #     echo "=== Generation Summary ==="
    #     echo "Job status: ${{ job.status }}"
    #     echo ""
        
    #     # Show generated documentation files
    #     if [ -d "generated/multi-page" ]; then
    #       echo "âœ… Generated documentation files:"
    #       find generated/multi-page -name "*.md" -type f | sort | while read -r file; do
    #         size=$(stat -c%s "$file" 2>/dev/null || echo "0")
    #         size_kb=$((size / 1024))
    #         echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
    #       done
    #     else
    #       echo "âš ï¸  No multi-page documentation directory found"
    #     fi
        
    #     # Show example prompt files
    #     echo ""
    #     if [ -d "generated/example-prompts" ]; then
    #       echo "âœ… Generated example prompt files:"
    #       example_count=$(find generated/example-prompts -name "*.md" -type f | wc -l)
    #       echo "  ðŸ“„ ${example_count} example prompt files"
    #       find generated/example-prompts -name "*.md" -type f | sort | head -10 | while read -r file; do
    #         size=$(stat -c%s "$file" 2>/dev/null || echo "0")
    #         size_kb=$((size / 1024))
    #         echo "    â€¢ $(basename "$file") (${size_kb}KB)"
    #       done
    #       if [ $example_count -gt 10 ]; then
    #         echo "    ... and $((example_count - 10)) more files"
    #       fi
    #     else
    #       echo "âš ï¸  No example-prompts directory found"
    #     fi
        
    #     # Show data files
    #     echo ""
    #     echo "Data files:"
    #     for file in generated/*.json generated/*.csv; do
    #       if [ -f "$file" ]; then
    #         size=$(stat -c%s "$file" 2>/dev/null || echo "0")
    #         size_kb=$((size / 1024))
    #         echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
    #       fi
    #     done
        
    #     # Show summary if available
    #     if [ -f "generated/generation-summary.md" ]; then
    #       echo ""
    #       echo "=== Summary from generation-summary.md ==="
    #       head -20 generated/generation-summary.md
    #     fi
        
    #     echo "=== End Summary ==="
        
    # - name: Upload generated documentation
    #   uses: actions/upload-artifact@v4
    #   if: always()
    #   with:
    #     name: generated-docs-${{ github.run_id }}-$(date +%Y-%m-%d-%H-%M)
    #     path: |
    #       generated/
    #     retention-days: 30

    # Optional: Push to GitHub Container Registry
    # Uncomment if you want to publish the image
    # - name: Login to GitHub Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}
    #
    # - name: Push Docker image
    #   run: |
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
