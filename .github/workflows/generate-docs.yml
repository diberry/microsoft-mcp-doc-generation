name: Generate MCP Documentation

on:
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  ARTIFACT_RETENTION_DAYS: 10
  ENABLE_AI_GENERATION: ${{ secrets.ENABLE_AI_GENERATION || 'false' }}  # Set repo secret to 'true' to enable expensive AI example prompt generation

jobs:
  # Job 1: Generate CLI Output (fast, ~2 min)
  generate-cli-output:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v5
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Generate MCP CLI output files
      run: |
        chmod +x ./run-mcp-cli-output.sh
        ./run-mcp-cli-output.sh
    
    - name: Upload CLI output artifact
      uses: actions/upload-artifact@v4
      with:
        name: cli-output-${{ github.run_id }}
        path: |
          generated/cli/
        retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  # Job 2: Generate Documentation (medium, ~3-4 min)
  generate-documentation:
    runs-on: ubuntu-latest
    needs: [generate-cli-output]
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v5
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Download CLI output artifact
      uses: actions/download-artifact@v4
      with:
        name: cli-output-${{ github.run_id }}
        path: generated/cli/
    
    - name: Run content generation (documentation)
      run: |
        chmod +x ./run-content-generation-output.sh
        ./run-content-generation-output.sh

    - name: Upload documentation artifact
      uses: actions/upload-artifact@v4
      with:
        name: documentation-${{ github.run_id }}
        path: |
          generated/
        retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  # Job 3: Generate Example Prompts with AI (slow, ~5-10 min, will grow)
  # Only runs if ENABLE_AI_GENERATION is set to 'true'
  generate-example-prompts:
    runs-on: ubuntu-latest
    needs: [generate-documentation]
    if: env.ENABLE_AI_GENERATION == 'true'
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v5
    
    - name: Download documentation artifact
      uses: actions/download-artifact@v4
      with:
        name: documentation-${{ github.run_id }}
        path: generated/
      
    - name: Create .env file for AI generation
      run: |
        echo "=== Validating required environment variables ==="
        
        # Check for empty variables
        MISSING_VARS=""
        
        if [ -z "${{ secrets.FOUNDRY_API_KEY }}" ]; then
          MISSING_VARS="${MISSING_VARS}- FOUNDRY_API_KEY\n"
        fi
        
        if [ -z "${{ secrets.FOUNDRY_ENDPOINT }}" ]; then
          MISSING_VARS="${MISSING_VARS}- FOUNDRY_ENDPOINT\n"
        fi
        
        if [ -z "${{ secrets.FOUNDRY_MODEL_NAME }}" ]; then
          MISSING_VARS="${MISSING_VARS}- FOUNDRY_MODEL_NAME\n"
        fi
        
        if [ -z "${{ secrets.FOUNDRY_MODEL_API_VERSION }}" ]; then
          MISSING_VARS="${MISSING_VARS}- FOUNDRY_MODEL_API_VERSION\n"
        fi
        
        # If any variables are missing, fail with clear message
        if [ -n "$MISSING_VARS" ]; then
          echo "âŒ ERROR: Required environment variables are missing!"
          echo ""
          echo "The following GitHub secrets are not set or are empty:"
          echo -e "$MISSING_VARS"
          echo ""
          echo "Please configure these secrets in:"
          echo "  Settings â†’ Secrets and variables â†’ Actions â†’ Repository secrets"
          echo ""
          exit 1
        fi
        
        echo "âœ… All required environment variables are set"
        echo ""
        
        echo "=== Creating .env file ==="
        mkdir -p docs-generation
        {
          echo "FOUNDRY_API_KEY=${{ secrets.FOUNDRY_API_KEY }}"
          echo "FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }}"
          echo "FOUNDRY_MODEL_NAME=${{ secrets.FOUNDRY_MODEL_NAME }}"
          echo "FOUNDRY_MODEL_API_VERSION=${{ secrets.FOUNDRY_MODEL_API_VERSION }}"
        } > docs-generation/.env
        echo "âœ… .env file created"
        echo "ðŸ“„ .env contents (keys only):"
        grep -E '^[A-Z_]+=' docs-generation/.env | cut -d= -f1
        echo "ðŸ“„ Variable values check:"
        echo "  FOUNDRY_API_KEY: $(grep FOUNDRY_API_KEY docs-generation/.env | cut -d= -f2 | cut -c1-6)...[MASKED]"
        echo "  FOUNDRY_ENDPOINT: $(grep FOUNDRY_ENDPOINT docs-generation/.env | cut -d= -f2)"

    - name: Run generative AI (example prompts)
      run: |
        chmod +x ./run-generative-ai-output.sh
        ./run-generative-ai-output.sh

    - name: Upload final output artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: final-output-${{ github.run_id }}
        path: |
          generated/
        retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

    # - name: Display generation summary
    #   if: always()
    #   run: |
    #     echo "=== Generation Summary ==="
    #     echo "Job status: ${{ job.status }}"
    #     echo ""
        
    #     # Show generated documentation files
    #     if [ -d "generated/multi-page" ]; then
    #       echo "âœ… Generated documentation files:"
    #       find generated/multi-page -name "*.md" -type f | sort | while read -r file; do
    #         size=$(stat -c%s "$file" 2>/dev/null || echo "0")
    #         size_kb=$((size / 1024))
    #         echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
    #       done
    #     else
    #       echo "âš ï¸  No multi-page documentation directory found"
    #     fi
        
    #     # Show example prompt files
    #     echo ""
    #     if [ -d "generated/example-prompts" ]; then
    #       echo "âœ… Generated example prompt files:"
    #       example_count=$(find generated/example-prompts -name "*.md" -type f | wc -l)
    #       echo "  ðŸ“„ ${example_count} example prompt files"
    #       find generated/example-prompts -name "*.md" -type f | sort | head -10 | while read -r file; do
    #         size=$(stat -c%s "$file" 2>/dev/null || echo "0")
    #         size_kb=$((size / 1024))
    #         echo "    â€¢ $(basename "$file") (${size_kb}KB)"
    #       done
    #       if [ $example_count -gt 10 ]; then
    #         echo "    ... and $((example_count - 10)) more files"
    #       fi
    #     else
    #       echo "âš ï¸  No example-prompts directory found"
    #     fi
        
    #     # Show data files
    #     echo ""
    #     echo "Data files:"
    #     for file in generated/*.json generated/*.csv; do
    #       if [ -f "$file" ]; then
    #         size=$(stat -c%s "$file" 2>/dev/null || echo "0")
    #         size_kb=$((size / 1024))
    #         echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
    #       fi
    #     done
        
    #     # Show summary if available
    #     if [ -f "generated/generation-summary.md" ]; then
    #       echo ""
    #       echo "=== Summary from generation-summary.md ==="
    #       head -20 generated/generation-summary.md
    #     fi
        
    #     echo "=== End Summary ==="
        
    # - name: Upload generated documentation
    #   uses: actions/upload-artifact@v4
    #   if: always()
    #   with:
    #     name: generated-docs-${{ github.run_id }}-$(date +%Y-%m-%d-%H-%M)
    #     path: |
    #       generated/
    #     retention-days: 30

    # Optional: Push to GitHub Container Registry
    # Uncomment if you want to publish the image
    # - name: Login to GitHub Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}
    #
    # - name: Push Docker image
    #   run: |
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
