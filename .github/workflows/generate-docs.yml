name: Generate MCP Documentation

on:
  schedule:
    # Run nightly at 2:00 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v5
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build MCP CLI output generator image
      run: |
        echo "=== Building Azure MCP CLI Output Generator ==="
        docker build \
          --tag azure-mcp-cli-output:latest \
          --build-arg MCP_BRANCH=main \
          --progress=plain \
          -f Dockerfile.mcp-cli-output \
          .
        
        echo "âœ… CLI output generator image built successfully"
        docker images azure-mcp-cli-output:latest
    
    - name: Generate MCP CLI output files
      run: |
        echo "=== Generating MCP CLI Output Files ==="
        
        # Create output directory
        mkdir -p generated/cli
        
        # Run CLI output generator
        docker run \
          --rm \
          --volume "$(pwd)/generated/cli:/output/cli" \
          azure-mcp-cli-output:latest
        
        echo "=== Verifying CLI Output ==="
        if [ -f "generated/cli/cli-output.json" ] && \
           [ -f "generated/cli/cli-namespace.json" ] && \
           [ -f "generated/cli/cli-version.json" ]; then
          echo "âœ… CLI output files generated successfully"
          ls -lh generated/cli/
        else
          echo "âŒ CLI output generation failed"
          exit 1
        fi
    
    - name: Upload CLI output artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mcp-cli-output
        path: |
          generated/cli/
        retention-days: 30
      
    - name: Build documentation generator image
      run: |
        echo "=== Building Azure MCP Documentation Generator ==="
        docker build \
          --tag azure-mcp-docgen:latest \
          --build-arg MCP_BRANCH=main \
          --progress=plain \
          .
        
        echo "âœ… Docker image built successfully"
        docker images azure-mcp-docgen:latest
        
    - name: Create .env file for documentation generation
      run: |
        echo "=== Creating .env file ==="
        mkdir -p docs-generation
        cat > docs-generation/.env << EOF
        FOUNDRY_API_KEY="${{ secrets.FOUNDRY_API_KEY }}"
        FOUNDRY_ENDPOINT="${{ secrets.FOUNDRY_ENDPOINT }}"
        FOUNDRY_MODEL_NAME="${{ secrets.FOUNDRY_MODEL_NAME }}"
        FOUNDRY_MODEL_API_VERSION="${{ secrets.FOUNDRY_MODEL_API_VERSION }}"
        EOF
        echo "âœ… .env file created"
    
    - name: Run documentation generation
      run: |
        echo "=== Running Documentation Generation ==="
        
        # CLI output files are already in generated/cli from previous step
        # Run the container with SKIP_CLI_GENERATION=true
        docker run \
          --rm \
          --volume "$(pwd)/generated:/output" \
          --volume "$(pwd)/docs-generation/.env:/docs-generation/.env:ro" \
          --env DOTNET_ROLL_FORWARD=Major \
          --env MCP_SERVER_PATH=/mcp/servers/Azure.Mcp.Server/src \
          --env SKIP_CLI_GENERATION=true \
          azure-mcp-docgen:latest
        
        echo "=== Verifying Generated Output ==="
        if [ -d "generated/multi-page" ]; then
          echo "âœ… Documentation generated successfully"
          file_count=$(find generated/multi-page -name "*.md" -type f | wc -l)
          echo "ðŸ“„ ${file_count} markdown files created"
        else
          echo "âŒ Documentation generation failed"
          ls -la generated/
          exit 1
        fi
        
    - name: Run example prompt generation
      run: |
        echo "=== Running Example Prompt Generation ==="
        
        # Run example prompt generation using the root-level script
        docker run \
          --rm \
          --volume "$(pwd)/generated:/output" \
          --volume "$(pwd)/docs-generation/.env:/docs-generation/.env:ro" \
          --volume "$(pwd)/run-generative-ai-output.sh:/run-generative-ai-output.sh:ro" \
          --env DOTNET_ROLL_FORWARD=Major \
          --env MCP_SERVER_PATH=/mcp/servers/Azure.Mcp.Server/src \
          azure-mcp-docgen:latest \
          bash /run-generative-ai-output.sh
        
        echo "=== Verifying Example Prompts Output ==="
        if [ -d "generated/example-prompts" ]; then
          echo "âœ… Example prompts generated successfully"
          file_count=$(find generated/example-prompts -name "*.md" -type f | wc -l)
          echo "ðŸ“„ ${file_count} example prompt files created"
        else
          echo "âŒ Example prompt generation failed"
          ls -la generated/
          exit 1
        fi
        
    - name: Display generation summary
      if: always()
      run: |
        echo "=== Generation Summary ==="
        echo "Job status: ${{ job.status }}"
        echo ""
        
        # Show generated documentation files
        if [ -d "generated/multi-page" ]; then
          echo "âœ… Generated documentation files:"
          find generated/multi-page -name "*.md" -type f | sort | while read -r file; do
            size=$(stat -c%s "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
          done
        else
          echo "âš ï¸  No multi-page documentation directory found"
        fi
        
        # Show example prompt files
        echo ""
        if [ -d "generated/example-prompts" ]; then
          echo "âœ… Generated example prompt files:"
          example_count=$(find generated/example-prompts -name "*.md" -type f | wc -l)
          echo "  ðŸ“„ ${example_count} example prompt files"
          find generated/example-prompts -name "*.md" -type f | sort | head -10 | while read -r file; do
            size=$(stat -c%s "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            echo "    â€¢ $(basename "$file") (${size_kb}KB)"
          done
          if [ $example_count -gt 10 ]; then
            echo "    ... and $((example_count - 10)) more files"
          fi
        else
          echo "âš ï¸  No example-prompts directory found"
        fi
        
        # Show data files
        echo ""
        echo "Data files:"
        for file in generated/*.json generated/*.csv; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            echo "  ðŸ“„ $(basename "$file") (${size_kb}KB)"
          fi
        done
        
        # Show summary if available
        if [ -f "generated/generation-summary.md" ]; then
          echo ""
          echo "=== Summary from generation-summary.md ==="
          head -20 generated/generation-summary.md
        fi
        
        echo "=== End Summary ==="
        
    - name: Upload generated documentation
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generated-docs
        path: |
          generated/
        retention-days: 30

    # Optional: Push to GitHub Container Registry
    # Uncomment if you want to publish the image
    # - name: Login to GitHub Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}
    #
    # - name: Push Docker image
    #   run: |
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker tag azure-mcp-docgen:latest ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:latest
    #     docker push ghcr.io/${{ github.repository }}/azure-mcp-docgen:${{ github.sha }}
